---
---
    <!-- Enhanced Music Controls -->
    <div class="music-controls">
        <div class="controls-container">
            <!-- Track Info -->
            <div class="track-info">
                <img id="albumArt" src="/pics/null.jpg" alt="Album Art" class="album-art">
                <div class="song-details">
                    <div class="song-title" id="songTitle">Select a track to play</div>
                    <div class="song-artist" id="songArtist">PR-Studios</div>
                </div>
                <button class="control-btn" id="favoriteBtn" title="Add to Favorites">
                    <i class="far fa-heart"></i>
                </button>
            </div>

            <!-- Player Controls -->
            <div class="player-controls">
                <div class="control-buttons">
                    <button class="control-btn" id="shuffleControl" title="Shuffle">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="control-btn" id="prevTrack" title="Previous">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-pause-btn" id="playPause" title="Play/Pause">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" id="nextTrack" title="Next">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn" id="repeatControl" title="Repeat">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>

                <div class="progress-container">
                    <span class="time-label" id="currentTime">0:00</span>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <span class="time-label" id="totalTime">0:00</span>
                </div>
            </div>

            <!-- Volume Controls -->
            <div class="volume-controls">
                <button class="control-btn" id="playlistBtn" title="Current Playlist">
                    <i class="fas fa-list"></i>
                </button>
                <button class="volume-btn" id="volumeBtn" title="Volume">
                    <i class="fas fa-volume-up"></i>
                </button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
            </div>
        </div>
    </div>
<style>
        /* Music Controls */
        .music-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 1rem 2rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .controls-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 2rem;
            align-items: center;
        }

        .track-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
        }

        .album-art {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: var(--shadow);
        }

        .song-details {
            min-width: 0;
            flex: 1;
        }

        .song-title {
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-artist {
            color: var(--muted-foreground);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--foreground);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: var(--accent);
            transform: scale(1.1);
        }

        .play-pause-btn {
            background: var(--gradient);
            color: white;
            font-size: 1.5rem;
            width: 50px;
            height: 50px;
        }

        .play-pause-btn:hover {
            background: var(--gradient);
            box-shadow: var(--hover-glow);
        }

        .progress-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .time-label {
            font-size: 0.75rem;
            color: var(--muted-foreground);
            min-width: 35px;
            text-align: center;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .progress {
            height: 100%;
            background: var(--gradient);
            border-radius: 3px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .progress-bar:hover .progress::after {
            opacity: 1;
        }

        .volume-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: flex-end;
        }

        .volume-btn {
            background: none;
            border: none;
            color: var(--foreground);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .volume-slider {
            width: 100px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }
</style>
<script>
        // Enhanced Player State
        let currentAudio = null;
        let isPlaying = false;
        let currentPlaylist = [];
        let currentTrackIndex = 0;
        let isShuffled = false;
        let repeatMode = 0; // 0: no repeat, 1: repeat all, 2: repeat one
        let currentVolume = 1;
        let isMuted = false;

        // DOM Elements
        const elements = {
            playPause: document.getElementById('playPause'),
            nextTrack: document.getElementById('nextTrack'),
            prevTrack: document.getElementById('prevTrack'),
            progressBar: document.getElementById('progressBar'),
            progress: document.getElementById('progress'),
            albumArt: document.getElementById('albumArt'),
            songTitle: document.getElementById('songTitle'),
            songArtist: document.getElementById('songArtist'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime'),
            volumeSlider: document.getElementById('volumeSlider'),
            volumeBtn: document.getElementById('volumeBtn'),
            shuffleControl: document.getElementById('shuffleControl'),
            // shuffleBtn: document.getElementById('shuffleBtn'), // This id does not exist in the HTML
            repeatControl: document.getElementById('repeatControl'),
            // repeatBtn: document.getElementById('repeatBtn'), // This id does not exist in the HTML
            // themeToggle: document.getElementById('themeToggle'), // This id does not exist in the HTML
            favoriteBtn: document.getElementById('favoriteBtn'),
            playlistBtn: document.getElementById('playlistBtn'),
            // modal: document.getElementById('playlistModal'), // This id does not exist in this component
            // modalClose: document.getElementById('modalClose'), // This id does not exist in this component
            // modalSongList: document.getElementById('modalSongList'), // This id does not exist in this component
            // modalTitle: document.getElementById('modalTitle') // This id does not exist in this component
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            // Set initial playlist
            // This will be populated from the MainContent component
            
            // Initialize volume
            elements.volumeSlider.value = currentVolume;
             // Set default image to be root-relative
            elements.albumArt.src = '/pics/null.jpg';
        }

        function setupEventListeners() {
            // Player controls
            elements.playPause.addEventListener('click', togglePlayPause);
            elements.nextTrack.addEventListener('click', playNext);
            elements.prevTrack.addEventListener('click', playPrevious);
            
            // Progress bar
            elements.progressBar.addEventListener('click', seekTrack);
            
            // Volume controls
            elements.volumeSlider.addEventListener('input', updateVolume);
            elements.volumeBtn.addEventListener('click', toggleMute);
            
            // Playlist controls
            elements.shuffleControl.addEventListener('click', toggleShuffle);
            // elements.shuffleBtn.addEventListener('click', toggleShuffle);
            elements.repeatControl.addEventListener('click', toggleRepeat);
            // elements.repeatBtn.addEventListener('click', toggleRepeat);
            
            // UI controls
            // elements.themeToggle.addEventListener('click', toggleTheme);
            elements.favoriteBtn.addEventListener('click', toggleFavorite);
            elements.playlistBtn.addEventListener('click', () => {
                // Dispatch a custom event to show the playlist modal
                document.dispatchEvent(new CustomEvent('show-playlist-modal'));
            });
            
            // Listen for custom track selection event from MainContent.astro
            document.addEventListener('track-selected', (event) => {
                const { track, playlist } = event.detail;
                playTrack(track, playlist);
                console.log('Track selected from MainContent:', track.title);
            });
        }

        function playTrack(track, playlist = null) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.removeEventListener('timeupdate', updateProgress);
                currentAudio.removeEventListener('ended', handleTrackEnd);
            }
            
            currentAudio = new Audio(track.audio);
            currentAudio.volume = currentVolume;
            
            if (playlist) {
                currentPlaylist = playlist;
                currentTrackIndex = playlist.findIndex(t => t.audio === track.audio);
            } else {
                currentPlaylist = [track]; // If single track, make it a playlist of one
                currentTrackIndex = 0;
            }
            
            // Update UI
            elements.albumArt.src = track.image;
            elements.songTitle.textContent = track.title;
            elements.songArtist.textContent = track.artist;
            
            // Setup event listeners
            currentAudio.addEventListener('timeupdate', updateProgress);
            currentAudio.addEventListener('ended', handleTrackEnd);
            currentAudio.addEventListener('loadedmetadata', function() {
                elements.totalTime.textContent = formatTime(currentAudio.duration);
            });
            
            // Play the track
            currentAudio.play().then(() => {
                isPlaying = true;
                updatePlayPauseButton();
            }).catch(error => {
                console.error('Error playing track:', error);
            });
        }

        function togglePlayPause() {
            if (!currentAudio) return; // No track loaded yet
            
            if (isPlaying) {
                currentAudio.pause();
                isPlaying = false;
            } else {
                currentAudio.play().then(() => {
                    isPlaying = true;
                }).catch(error => {
                    console.error('Error playing track:', error);
                });
            }
            updatePlayPauseButton();
        }

        function updatePlayPauseButton() {
            const icon = elements.playPause.querySelector('i');
            icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        }

        function playNext() {
            if (currentPlaylist.length === 0) return;
            
            if (isShuffled) {
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * currentPlaylist.length);
                } while (newIndex === currentTrackIndex && currentPlaylist.length > 1); // Avoid playing same song twice in a row if shuffled and more than one song
                currentTrackIndex = newIndex;
            } else {
                currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
            }
            
            playTrack(currentPlaylist[currentTrackIndex]);
        }

        function playPrevious() {
            if (currentPlaylist.length === 0) return;
            
            if (isShuffled) {
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * currentPlaylist.length);
                } while (newIndex === currentTrackIndex && currentPlaylist.length > 1); // Avoid playing same song twice in a row if shuffled and more than one song
                currentTrackIndex = newIndex;
            } else {
                currentTrackIndex = currentTrackIndex === 0 ? currentPlaylist.length - 1 : currentTrackIndex - 1;
            }
            
            playTrack(currentPlaylist[currentTrackIndex]);
        }

        function handleTrackEnd() {
            if (repeatMode === 2) { // Repeat one
                currentAudio.currentTime = 0;
                currentAudio.play();
            } else if (repeatMode === 1 || currentTrackIndex < currentPlaylist.length - 1) { // Repeat all or more tracks
                playNext();
            } else {
                // End of playlist
                isPlaying = false;
                updatePlayPauseButton();
                // Optionally reset UI to default "Select a track to play"
                elements.albumArt.src = '/pics/null.jpg';
                elements.songTitle.textContent = 'Select a track to play';
                elements.songArtist.textContent = 'PR-Studios';
                elements.currentTime.textContent = '0:00';
                elements.totalTime.textContent = '0:00';
                elements.progress.style.width = '0%';
            }
        }

        function updateProgress() {
            if (!currentAudio || isNaN(currentAudio.duration)) return; // Ensure duration is a number
            
            const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
            elements.progress.style.width = `${progress}%`;
            elements.currentTime.textContent = formatTime(currentAudio.currentTime);
        }

        function seekTrack(e) {
            if (!currentAudio || isNaN(currentAudio.duration)) return;
            
            const rect = elements.progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            currentAudio.currentTime = percent * currentAudio.duration;
        }

        function updateVolume() {
            currentVolume = parseFloat(elements.volumeSlider.value); // Ensure it's a float
            if (currentAudio) {
                currentAudio.volume = currentVolume;
                isMuted = currentVolume === 0; // Update mute state based on slider
            }
            
            updateVolumeIcon();
        }

        function toggleMute() {
            if (isMuted) {
                elements.volumeSlider.value = currentVolume === 0 ? 1 : currentVolume; // Restore to prev volume or full if prev was 0
                if (currentAudio) currentAudio.volume = elements.volumeSlider.value;
                isMuted = false;
            } else {
                elements.volumeSlider.value = 0;
                if (currentAudio) currentAudio.volume = 0;
                isMuted = true;
            }
            
            updateVolumeIcon();
        }

        function updateVolumeIcon() {
            const icon = elements.volumeBtn.querySelector('i');
            const volume = parseFloat(elements.volumeSlider.value);
            
            if (volume === 0 || isMuted) {
                icon.className = 'fas fa-volume-mute';
            } else if (volume < 0.5) {
                icon.className = 'fas fa-volume-down';
            } else {
                icon.className = 'fas fa-volume-up';
            }
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            elements.shuffleControl.classList.toggle('active', isShuffled);
            // console.log('Shuffle toggled:', isShuffled);
        }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            
            const repeatIcons = ['fas fa-redo', 'fas fa-redo', 'fas fa-redo-alt'];
            const repeatClasses = ['', 'active', 'active']; // No 'active' for repeatMode 0
            
            elements.repeatControl.querySelector('i').className = repeatIcons[repeatMode];
            elements.repeatControl.classList.remove('active', 'fas', 'fa-redo', 'fa-redo-alt'); // Clean up old classes
            if (repeatMode === 1) {
                 elements.repeatControl.classList.add('active', 'fas', 'fa-redo');
            } else if (repeatMode === 2) {
                 elements.repeatControl.classList.add('active', 'fas', 'fa-redo-alt');
            } else {
                elements.repeatControl.classList.add('fas', 'fa-redo');
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const icon = elements.themeToggle.querySelector('i');
            icon.className = document.body.classList.contains('light-mode') ? 'fas fa-moon' : 'fas fa-sun';
        }

        function toggleFavorite() {
            const icon = elements.favoriteBtn.querySelector('i');
            icon.classList.toggle('fas');
            icon.classList.toggle('far');
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
</script>